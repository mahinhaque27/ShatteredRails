<!DOCTYPE html>
{% load static %}
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shattered Rails</title>
    <style>
        .save-button {
            margin-top: 20px;
            padding: 15px 20px;
            color: white;
            background-color: green; 
            border: 1px solid #ccc; 
            border-radius: 4px;
            cursor: pointer;
            display: block; 
            font-size: 24px;
        }
        .reset-button {
            margin-top: 20px;
            padding: 15px 20px;
            color: white;
            background-color: red; 
            border: 1px solid #ccc; 
            border-radius: 4px;
            cursor: pointer;
            display: block; 
            font-size: 24px;
        }
            
        .settings-popup {
            position: fixed;
            top: 0;
            right: -400px; 
            width: 300px;
            height: 100%;
            background-color: black; 
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.5);
            transition: right 0.5s;
            z-index: 1000;
            padding: 20px; 
            font-size: 18px; 
            overflow-y: auto;
            color: #ecf0f1; 
        }
        
        .settings-popup.open {
            right: 0;
        }
        
        .settings-popup h2 {
            color: #ecf0f1;
            font-size: 24px; 
            margin-bottom: 20px; 
            text-align: center; 
        }
        
        .settings-popup label {
            display: block;
            margin-bottom: 10px;
            color: #ecf0f1; 
        }
        
        .settings-popup input[type="color"],
        .settings-popup select {
            display: block;
            width: 100%; 
            margin-bottom: 20px; 
            border: 1px solid #34495e;
            background-color: #34495e;
            color: #ecf0f1; 
            padding: 10px; 
            border-radius: 4px; 
        }
        
        .settings-popup .button {
            background-color: #16a085; 
            color: white; 
            text-transform: uppercase; 
            font-weight: bold; 
            border: none; 
            border-radius: 4px; 
            padding: 10px 20px; 
            cursor: pointer; 
            margin-bottom: 20px; 
            width: 100%; 
            box-sizing: border-box; 
            transition: background-color 0.3s ease; 
        }
        
        .settings-popup .button:hover {
            background-color: #1abc9c; 
        }
        
        .settings-popup .close-popup {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #c0392b; 
            cursor: pointer;
            font-size: 24px;
        }
        .close-button {
            color: black;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        
        .terminal-container {
            background-color: #121212; 
            
            padding: 20px; 
            margin-top: 20px; 
            border: 2px solid #d98b55; 
            animation: pulseBackground 2s infinite; 

            box-sizing: border-box;
            width: 100%;
        }
        
        @keyframes pulseBackground {
            0%, 100% {
                box-shadow: 0 0 10px #d98b55, 0 0 20px d98b55, 0 0 30px d98b55;
                border-color: d98b55;
            }
            50% {
                box-shadow: 0 0 20px #d98b55, 0 0 40px #d98b55, 0 0 60px #d98b55;
                border-color: #d98b55;
            }
        }
        body {
            font-family: monospace;
            background-color: rgb(15, 19, 27);
            overflow: auto;
            height: 100vh;
            
            justify-content: center;
            align-items: center; 

            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .sidebar.active {
            transform: translateX(0); 
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 40%; 
            }

            .content, .terminal-container {
                width: 100%; 
                padding: 10px; 
            }


            .menu-bar a, .button, .logout-button, .help-button {
                font-size: smaller; 
            }
        }

        @media (max-width: 576px) {
            .sidebar {
                width: 60%; 
                transform: translateX(-100%); 
            }
            
            .content {
                margin-top: 20px; 
            }

            .terminal-container {
                max-height: 200px; 
            }
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 10; 
            left: 0;
            top: 15;
            width: 100%; 
            height: 100%; 
            overflow: none; 
            background-color: rgb(0,0,0); 
            background-color: rgba(0,0,0,0.4); 
        }

        .modal button {
            border-radius: 15px;
            font-size: 15px;
            width: 20%;
            height: 30%;
            cursor: pointer;
        }

        .modal button:hover {
            background-color: #007bff;
        }



        .modal-content {
                position: relative; 
                margin: auto; 
                padding: 50px;
                border: 0.5px solid #FFA500; 
                width: 50%; 
                max-width: 600px; 
                background-color: #000; 
                color: white; 
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2), 0 6px 20px rgba(0, 0, 0, 0.19); 
                border-radius: 10px; 
            }

            .modal-content::before {
                content: '';
                position: absolute;
                top: -2px;
                right: -2px;
                bottom: -2px;
                left: -2px;
                z-index: -1;
                background: linear-gradient(40deg, #FFA500, #FFD700, #FFA500);
                background-size: 200% 200%;
                animation: gradient-border 2s linear infinite;
                border-radius: 10px;
                filter: blur(5px);
            }

            @keyframes gradient-border {
                0% {
                    background-position: 0 50%;
                }
                50% {
                    background-position: 100% 50%;
                }
                100% {
                    background-position: 0 50%;
                }
            }

            .confirm-button {
                background-color: black;
                color: black;
                padding: 10px 20px;
                border: none;
                cursor: pointer;
                border-radius: 5px;
                margin: 5px;
                transition: background-color 0.3s ease;
            }
            .modal {
                display: flex; 
                align-items: center; 
                justify-content: center; /
            }



        .black-font {
            color: black;
        }
        #restartModal .black-font {
            color: black !important;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            color: white;
            width: 85%;
        }

        .menu-bar {
            display: flex;
            justify-content: flex-end;
            padding: 20px;
            list-style: none;
        }

        .menu-bar a {
            color: white;
            padding: 20px 40px;
            text-decoration: none;
            margin: 0 10px;
            border: 2px solid white;
            border-radius: 40px;
            transition: background-color 0.3s;
        }

        .menu-bar a:hover {
            background-color: #007bff;
        }

        .center-title {
            text-align: center;
        }
        .terminal-container {
            
            width: 100%;
            height: 60%;
            background-color: #121212; 
            
            border-radius: 10px;
            overflow-x: hidden;

            display: flex;
            justify-content: center; 
            align-items: center; 
            box-shadow: 0 0 15px 5px rgba(255, 255, 255, 0.75);
            animation: glowPulse 2s infinite ease-in-out;
    }

@keyframes glowPulse {
    0%, 100% {
        box-shadow: 
            0 0 10px 0 rgba(255, 255, 255, 0.5), 
            0 0 20px 10px rgba(255, 255, 255, 0.3), 
            0 0 30px 20px rgba(255, 255, 255, 0.1);
    }
    50% {
        box-shadow: 
            0 0 15px 5px rgba(255, 255, 255, 0.75), 
            0 0 25px 15px rgba(255, 255, 255, 0.5), 
            0 0 35px 25px rgba(255, 255, 255, 0.25);
    }
            
        }

        .terminal-text,
        button {
            text-align: center;
            color: whitesmoke;
            font-size: 20px;
            font-family: 'Arial', sans-serif;
        }

        .logout-button {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 120px;
            height: 40px;
            background-color: blue;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 20px;
            font-family: 'Arial', sans-serif;
            border: 1px solid darkgrey;
            box-shadow: 0.5px 0.5px 2px darkgrey;
        }

        .speed-slider, .line-spacing-picker {
            width: 100px;
            margin: 20px auto;
        }

        .help-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 8%;
            height: 6%;
            background-color: orange;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 20px;
            
            border: 1px solid darkgrey;
            box-shadow: 0.5px 0.5px 2px darkgrey;
            transition: background-color 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .help-button:hover {
            background-color: rgb(184, 124, 11);
        }

        .buttons-container {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .label-highlight {
            background-color: white;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .profile-icon {
            width: 50px;
            height: 50px;
        }

        .button 
        {
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            margin: 0 10px;
            border: 2px solid white; 
            border-radius: 20px; 
            transition: background-color 0.3s;
            background-color: rgb(15, 19, 27); 
            font-size: 16px; 
            display: inline-block; 
            cursor: pointer; 
            text-align: center; 
            font-family: 'Arial', sans-serif; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
        }

        label
        {
            color: white;
            padding: 10px;
            font-size: 15px; 
            display: inline-block; 
            text-align: center; 
            font-family: 'Arial', sans-serif; 

        }
        .button:hover {
            background-color: #007bff; 
        }

        .name-input {
            display: flex;
            justify-content: center;
            
        }

        .progress {
            position:absolute;
            width: 210px;
            height: 30px;
            background: #596361;
            border-radius: 5px;
            overflow: hidden;
            left:0;

            margin-left: 1%;
        }

        .progress__fill {
            width: 0%;
            height: 100%;
            background: #0cb430;
            transition: all 0.2s;
        }

        .progress__text {
            position: absolute;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
            font: bold 14px "Quicksand", sans-serif;
            color: #ffffff;
            text-shadow: 2px 2px 4px #000000;
        }
        body {
            transition: background-image 0.5s ease-in-out;
            background-size: cover;
            background-position: center;
            overflow-x: hidden;
        }
        
        .fading-background {
            animation: fadeBackground 2s ease-in-out forwards;
        }
        
        @keyframes fadeBackground {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
            #hamburger-icon {
        display: none;
        cursor: pointer;
        flex-direction: column;
        gap: 5px;
        padding: 10px;
    }
    
    #hamburger-icon span {
        display: block;
        width: 30px;
        height: 3px;
        background-color: white;
    }
    
    #menu-items {
        display: flex; 
        gap: 10px;
    }
    
    @media (max-width: 768px) {
        #hamburger-icon {
            display: flex; 
        }
        
        #menu-items {
            display: none; 
            flex-direction: column;
            position: absolute;
            background-color: #333;
            top: 60px;
            right: 0;
            width: 100%;
        }
        .menu-bar {
            justify-content: space-between;
        }
        
        #menu-items.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #333; 
            position: fixed;
            top: 60px; 
            right: 0;
            width: 100%; 
            padding: 10px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    }

        
    </style>
</head>

<body>
    <div class="menu-bar">
        <div class="progress">
            <div class="progress__fill"></div>
            <span class="progress__text">0%</span>
        </div>
        <div id="hamburger-icon" onclick="toggleMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>
    
        
    <div id="menu-items">
        <a href="{% url 'index' %}">Home</a>
        <a href="{% url 'profile' %}">Profile</a>
        <a href="{% url 'index_2' %}">Game Selection</a>
        <a href="{% url 'logout' %}">Logout</a>
        <a href="#" id="settings-button" class="menu-item">Settings</a>   
    </div>

    <div id="settings-popup" class="settings-popup">
        <button id="close-popup" class="close-popup">&times;</button>
        <h2>Settings</h2>
        
        <div class="setting">
            <label for="background-color-picker">Background Color:</label>
            <input type="color" id="background-color-picker" value="#121212">
        </div>
        
        <div class="setting">
            <label for="font-family-picker">Font Family:</label>
            <select id="font-family-picker">
                <option value="Arial">Arial</option>
                <option value="Impact">Impact</option>
                <option value="Courier New">Courier New</option>
                <option value="Comic Sans MS">Comic Sans MS</option>
                <option value="Tahoma">Tahoma</option>
                <option value="Lucida Console">Lucida Console</option>
                <option value="Verdana">Verdana</option>
                <option value="Garamond">Garamond</option>
                <option value="Trebuchet MS">Trebuchet MS</option>
                <option value="Book Antiqua">Book Antiqua</option>
                <option value="Century Gothic">Century Gothic</option>
                <option value="Calibri">Calibri</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Georgia">Georgia</option>
                <option value="Arial Black">Arial Black</option>
            </select>
        </div>
        
        <div class="setting">
            <label for="font-size">Font Size:</label>
            <select id="font-size" onchange="changeFontSize(this.value)">
                <option value="12px">12px</option>
                <option value="14px">14px</option>
                <option value="16px">16px</option>
                <option value="18px">18px</option>
                <option value="19px">19px</option>
                <option value="20px">20px</option>
                <option value="21px">21px</option>
                <option value="22px">22px</option>
            </select>
        </div>
       
        <label for="text-speed-selector">Text Speed:</label>
        <select id="text-speed-selector">
            <option value="" disabled selected>Select speed</option>
            <option value="0.2">40x</option>
            <option value="0.5">30x</option>
            <option value="1">20x</option>
            <option value="2">10x</option>
            <option value="5">5x</option>
            <option value="10">1x</option>
            <option value="20">0.5x</option>
            <option value="30">0.3x</option>
            <option value="40">0.2x</option>
        </select>
        
    
        <label for="font-color-picker">Font Color:</label>
        <input type="color" id="font-color-picker" value="#d4af37">
    
        <label for="terminal-background-color-picker">Terminal Background Color:</label>
        <input type="color" id="terminal-background-color-picker" value="#121212">
    
        <div class="setting">
            <button id="reset-button" class="reset-button">Reset</button>
        </div>
        <div class="setting">
            <button id="save-button" class="save-button">Save</button>
            <p id="save-confirmation" style="color: limegreen; margin-top: 10px; display: none;">Settings saved!</p>
        </div>
        <div class ="setting">
            <label for="line-spacing-picker">Line Spacing:</label>
        <input type="range" min="1" max="3" step="0.1" value="1" class="line-spacing-picker" id="line-spacing-picker">
            
        <label for="speechToggle">Speech:</label>
        <input type="checkbox" id="speechToggle" style="margin-bottom: 20px;">

        <div class="buttons-container">
            <button class="button" onclick="toggleBold()">Bold</button>
        </div>
        <div class="buttons-container">
            <button class="button" onclick="zoomIn()" style="margin-left: 10px;">+</button>
        </div>
        <div class="buttons-container">
            <button class="button" onclick="zoomOut()" style="margin-left: 10px;">-</button>
        </div>
        <div class="buttons-container">
            <button class="button" onclick="Underline()">Underline</button>
        </div>
        <div class="buttons-container">
            <button class="button" onclick="Italics()">Italics</button>
        </div>
        <div class="buttons-container">
            <button class="button" id="align-left" style="margin-left: 10px;">Align Left</button>
        </div>
        <div class="buttons-container">
            <button class="button" id="align-center" style="margin-left: 10px;">Align Center</button>
        </div>
        <div class="buttons-container">
            <button class="button" id="align-right" style="margin-left: 10px;">Align Right</button>
        </div>
    </div>
</div>
  </div>
    <div>
        {% if user.is_authenticated %}
        {% if game %}

        
        <div id="restartModal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <p>Are you sure you want to restart the game?</p>
                <button class="black-font" onclick="confirmRestart()">Yes, restart</button>
                <button class="black-font" onclick="closeModal()">No, cancel</button>
            </div>
        </div>

    </div>

    <div class="terminal-container">
        <div class='terminal-text' id="output"></div>
    </div>
    <div class="buttons-container">
        <button class="button" id="pauseButton" onclick="pause()">Pause</button>
        <button class="button" onclick="restartGame()" style="margin-left: 10px;">Restart From Last Checkpoint</button>
    </div>
    <div class="buttons-container" id="button-container"></div>
    
    <div class="name-input" id="name-input-container"></div>
    
    </div>
        
        
    </div>

    <audio id="attackSound" src="{% static 'main/sounds/sword-swing.wav' %}" preload="auto"></audio>

    <div class="buttons-container" id="button-container"></div>

    <div class="name-input" id="name-input-container"></div>
    
    <a class="help-button" href="{% url 'help' %}">Help</a>

    <script>
        let name;
        let fontSize = 30;
        
        var save_state = JSON.parse('{{ game.save_state|safe }}');
        var completion = JSON.parse('{{ game.completion|safe }}');
        completion = completion * 10;

        document.getElementById("text-speed-selector").addEventListener("change", function() {
    var baseSpeed = 1000; 
    var speedMultiplier = parseFloat(this.value);
    textSpeed = baseSpeed / speedMultiplier; 

    console.log("Adjusted text speed to: " + textSpeed + " milliseconds per character.");
});

        //Pause function, when the user clicks pause, the text freezes, until the user clicks resume, when in the text resumes.
        let pauseStatus = false;
        function pause() {
            pauseStatus = !pauseStatus;
            const pauseButton = document.getElementById("pauseButton");
            if (pauseStatus) {
                pauseButton.textContent = "Resume";
            } else {
                pauseButton.textContent = "Pause";
            }
        }
        const caveImageUrl = "{% static 'main/images/cave.jpg' %}";
        const trailImageUrl = "{% static 'main/images/trail.jpg' %}";
        const realmImageUrl = "{% static 'main/images/realm.jpg' %}";
        const trainImageUrl = "{% static 'main/images/train.jpg' %}";
        const forestImageUrl = "{% static 'main/images/forest.jpg' %}";
    function changeBackgroundToTrain() {
    document.body.style.backgroundImage = `url('${trainImageUrl}')`;
    document.body.style.backgroundSize = "cover";
    document.body.classList.add('fading-background');
    setTimeout(() => document.body.classList.remove('fading-background'), 2000);
    document.body.style.backgroundRepeat = "no-repeat";
}

// Update the progress bar green fill as number updates
function updateProgressBar(progressBar, value) {
  const myProgressBar = document.querySelector(".progress");
  value = Math.round(value);
  progressBar.querySelector(".progress__fill").style.width = `${value}%`;
  progressBar.querySelector(".progress__text").textContent = `${value}%`;
}

const myProgressBar = document.querySelector(".progress");

// Ajax request to update the progress bar without having to refresh page
function updateProgressAjax() {
    fetch('/get_progress/') 
        .then(response => response.json())
        .then(data => {
            const progressBar = document.querySelector(".progress");
            const value = data.completion;
            progressBar.querySelector(".progress__fill").style.width = `${value * 10}%`;
            progressBar.querySelector(".progress__text").textContent = `${value * 10}%`;
        })
        .catch(error => console.error('Error updating progress bar:', error));
}

setInterval(updateProgressAjax, 100);

function changeBackgroundToCave() {
    document.body.style.backgroundImage = `url('${caveImageUrl}')`;
    document.body.style.backgroundSize = "cover";
    document.body.classList.add('fading-background');
    setTimeout(() => document.body.classList.remove('fading-background'), 2000);
    document.body.style.backgroundRepeat = "no-repeat";
}
function changeBackgroundToTrail() {
    document.body.style.backgroundImage = `url('${trailImageUrl}')`;
    document.body.style.backgroundSize = "cover";
    document.body.classList.add('fading-background');
    setTimeout(() => document.body.classList.remove('fading-background'), 2000);
    document.body.style.backgroundRepeat = "no-repeat";
}
function changeBackgroundToRealm() {
    document.body.style.backgroundImage = `url('${realmImageUrl}')`;
    document.body.style.backgroundSize = "cover";
    document.body.classList.add('fading-background');
    setTimeout(() => document.body.classList.remove('fading-background'), 2000);
    document.body.style.backgroundRepeat = "no-repeat";
}



function changeBackgroundToForest() {
    document.body.style.backgroundImage = `url('${forestImageUrl}')`;
    document.body.style.backgroundSize = "cover";
    document.body.classList.add('fading-background');
    setTimeout(() => document.body.classList.remove('fading-background'), 2000);
    document.body.style.backgroundRepeat = "no-repeat";
}

//function to dynamically generate buttons
async function promptChoice(inputText, choices) {
    return new Promise(resolve => {
        const containButton = document.getElementById("button-container");
        containButton.innerHTML = "";
        narrate(inputText);
        choices.forEach(option => {
            const button = document.createElement("button");
            button.textContent = option.label;
            button.className = 'button';
            button.onclick = () => resolve(option.value);

            if (option.label === "Go right") {
                button.addEventListener('click', changeBackgroundToCave);
            }
            if (option.label === "Go left") {
                button.addEventListener('click', changeBackgroundToTrail);
            }
         else if (option.label === "Go forward") {
                button.addEventListener('click', changeBackgroundToRealm);
            }
        else if (option.label === "Stay") {
                button.addEventListener('click', changeBackgroundToTrain);
            }
         else if (option.label === "Go behind") { 
                button.addEventListener('click', changeBackgroundToForest);
            }

            containButton.appendChild(button);
        });
    });
}

//function to output text with a delay
        function narrate(script) {
            return new Promise(resolve => {
                let start = 0;
                const outputDiv = document.getElementById("output");
                const contTerm = document.querySelector(".terminal-container");

                const intervalId = setInterval(() => 
                {
                    if (!pauseStatus)
                 {
                    outputDiv.innerHTML += script[start];
                    contTerm.scrollTop = contTerm.scrollHeight;

                    start += 1;
                    if (start === script.length) {
                        clearInterval(intervalId);
                        outputDiv.innerHTML += '<br><br>';
                        contTerm.scrollTop = contTerm.scrollHeight;
                        resolve();
                    }
                 }
                }, textSpeed);

            });

            
        }
//function for animations
    async function animNarrate(message, gifUrl,imageWidth, imageHeight) 
    {
    const terminalContainer = document.querySelector('.terminal-container');
    const container = document.createElement('div');
    container.innerHTML = `
        <p>${message}</p>
        <img src="${gifUrl}" alt="gif" style="position: absolute; top: 70%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; width: ${imageWidth}px; height: ${imageHeight}px;" />`;

    container.style.position = 'absolute';
    container.style.top = '0';
    container.style.left = '0';
    container.style.width = '100%';
    container.style.height = '100%';
    container.style.display = 'flex';
    container.style.justifyContent = 'center';
    container.style.alignItems = 'center';
    container.style.zIndex = '9999';

    terminalContainer.appendChild(container);

    const resizeObserver = new ResizeObserver(entries => {
        const terminalRect = entries[0].contentRect;
        const containerWidth = terminalRect.width;
        const containerHeight = terminalRect.height;

        container.style.width = containerWidth + 'px';
        container.style.height = containerHeight + 'px';
    });

    resizeObserver.observe(terminalContainer);

    await new Promise(resolve => setTimeout(resolve, 1000));

    resizeObserver.disconnect();
    container.remove();
    }
//function to play sounds
    async function playSound(soundLocation) {
    try {
        
        var sound = new Audio(soundLocation);
        await sound.play();
    } catch (error) {
        
        console.error("Error playing the sound:", error);
    }
}
document.getElementById("text-speed-selector").addEventListener("change", function () {
    textSpeed = parseFloat(this.value);
    console.log("Text speed changed to: " + textSpeed + "x");
});


        let gameMode;
        function toggleBold() {
            const terminalText = document.querySelector('.terminal-text');
            terminalText.style.fontWeight = (terminalText.style.fontWeight === 'bold') ? 'normal' : 'bold';
        }

        function zoomIn() {
            fontSize += 2;
            document.querySelector('.terminal-text').style.fontSize = fontSize + 'px';
        }

        function zoomOut() {
            fontSize -= 2;
            document.querySelector('.terminal-text').style.fontSize = fontSize + 'px';
        }
        
        async function restartGame() {
            const restart = confirm("Are you sure you want to restart the game?");
            if (restart) {
                try {
                    await saveGameState(0); // Wait for the game state to be saved
                    location.reload(); // Reload the page after the state is updated
                } catch (error) {
                    console.error('Error saving game state:', error);
                    // Handle the error (e.g., show a message to the user)
                }
            }
        }
function Underline() {
    const terminalText = document.querySelector('.terminal-text');
    const currentStyle = window.getComputedStyle(terminalText).textDecoration;
    const newStyle = (currentStyle === 'none' || currentStyle === '') ? 'underline' : 'none';
    terminalText.style.textDecoration = newStyle;
}
let textSpeed = 20; 
    let speechRate = 1; 


    document.getElementById("text-speed-selector").addEventListener("change", function () {
        textSpeed = parseFloat(this.value);
        speechRate = mapTextSpeedToSpeechRate(textSpeed);
        console.log("Text speed changed to: " + textSpeed + ", Speech rate: " + speechRate);
    });

 
    function mapTextSpeedToSpeechRate(textSpeed) {
  
        switch(textSpeed) {
            case 0.2: return 10; 
            case 0.5: return 8;
            case 1: return 6;
            case 2: return 4;
            case 5: return 2;
            case 10: return 1;
            case 20: return 0.5;
            case 30: return 0.3;
            case 40: return 0.1; 
            default: return 1; 
        }
    }

    
    function narrate(text) {
        if ('speechSynthesis' in window && document.getElementById("speechToggle").checked) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = speechRate;
            window.speechSynthesis.speak(utterance);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
    loadPreferences();
    setupEventListeners();
});

document.getElementById('terminal-background-color-picker').addEventListener('input', function() {
    const terminalContainer = document.querySelector('.terminal-container');
    terminalContainer.style.backgroundColor = this.value;
});

document.getElementById('font-color-picker').addEventListener('input', function() {
    const terminalText = document.querySelector('.terminal-text');
    terminalText.style.color = this.value;
});

 



document.addEventListener('DOMContentLoaded', function() {
    applySavedSettings();
    document.getElementById('settings-button').addEventListener('click', function(event) {
        event.preventDefault();
        document.getElementById('settings-popup').classList.toggle('open');
    });
    document.getElementById('close-popup').addEventListener('click', function() {
        document.getElementById('settings-popup').classList.remove('open');
    });

    var saveButton = document.getElementById('save-button');
    saveButton.addEventListener('click', function() {
        const bgColor = document.getElementById('terminal-background-color-picker').value;
        const fontColor = document.getElementById('font-color-picker').value;

        localStorage.setItem('terminalBgColor', bgColor);
        localStorage.setItem('fontColor', fontColor);

        document.getElementById('save-confirmation').style.display = 'block';
        setTimeout(() => {
            document.getElementById('save-confirmation').style.display = 'none';
        }, 2000);
    });

    function applySavedSettings() {
        const savedBgColor = localStorage.getItem('terminalBgColor');
        const savedFontColor = localStorage.getItem('fontColor');

        if (savedBgColor) {
            document.querySelector('.terminal-container').style.backgroundColor = savedBgColor;
        }
        if (savedFontColor) {
            document.querySelector('.terminal-text').style.color = savedFontColor;
        }
    }
});

function loadPreferences() {
    const terminalBgColor = localStorage.getItem('terminalBgColor') || '#121212'; 
    const fontColor = localStorage.getItem('fontColor') || '#FFFFFF'; 

    const terminalElement = document.querySelector('.terminal-container');
    terminalElement.style.backgroundColor = terminalBgColor;

    const textElements = document.querySelectorAll('.terminal-text');
    textElements.forEach(element => {
        element.style.color = fontColor;
    });
}


document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('terminal-background-color-picker').addEventListener('input', function() {
        const color = this.value;
        localStorage.setItem('terminalBgColor', color);
        document.querySelector('.terminal-container').style.backgroundColor = color;
    });

    document.getElementById('font-color-picker').addEventListener('input', function() {
        const color = this.value;
        localStorage.setItem('fontColor', color);
        document.querySelectorAll('.terminal-text').forEach(element => {
            element.style.color = color;
        });
    });


    loadPreferences();
});
function resetSettings() {

localStorage.removeItem('terminalBgColor');
localStorage.removeItem('fontColor');


const defaultTerminalBgColor = '#121212';
document.querySelector('.terminal-container').style.backgroundColor = defaultTerminalBgColor;
document.getElementById('terminal-background-color-picker').value = defaultTerminalBgColor;


const defaultFontColor = '#FFFFFF';
document.querySelectorAll('.terminal-text').forEach(element => {
    element.style.color = defaultFontColor;
});
document.getElementById('font-color-picker').value = defaultFontColor;


}


document.getElementById('reset-button').addEventListener('click', resetSettings);

function Italics() {
    const terminalText = document.querySelector('.terminal-text');
    const currentStyle = window.getComputedStyle(terminalText).fontStyle;
    const newStyle = (currentStyle === 'normal' || currentStyle === '') ? 'italic' : 'normal';
    terminalText.style.fontStyle = newStyle;

}
document.getElementById('align-left').addEventListener('click', function() {
    document.querySelector('.terminal-text').style.textAlign = 'left';
});

document.getElementById('align-center').addEventListener('click', function() {
    document.querySelector('.terminal-text').style.textAlign = 'center';
});

document.getElementById('align-right').addEventListener('click', function() {
    document.querySelector('.terminal-text').style.textAlign = 'right';
});
    function restartGame() {
    var modal = document.getElementById("restartModal");
    modal.style.display = "block";
    pauseStatus = true; // Pause the game when the modal is shown
}

function closeModal() {
    var modal = document.getElementById("restartModal");
    modal.style.display = "none";
    pauseStatus = false; // Resume the game when the modal is closed
}


// Close the modal if the user clicks anywhere outside of it
window.onclick = function(event) {
    var modal = document.getElementById("restartModal");
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

let isPaused = false;
//This is the function for speech recognition
if ('webkitSpeechRecognition' in window) {
    var recognition = new webkitSpeechRecognition();
    recognition.continuous = true; 
    recognition.lang = 'en-US';
    recognition.start();

    recognition.onresult = function(event) {
        var transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
        switch (transcript) {
            case 'zoom in':
                zoomIn();
                break;
            case 'zoom out':
                zoomOut();
                break;
            case 'pause':
                pause();
                break;
            case 'unpause':
                pause(); 
                break;
            case 'bold':
                toggleBold();
                break;
            case 'reverse bold':
                toggleBold(); 
                break;
            case 'restart game':
                restartGame(); 
                break;
            default:
                console.log('Unrecognized command:', transcript);
        }
    };

    //This is to restart the recognition when it ends
    recognition.onend = function() {
        recognition.start();
    };
} else {
    console.log('Speech recognition not supported in this browser.');
}
function confirmRestart() {
    location.reload(); // Reload the page to restart the game
}






let lastTime;
let timeout;

//This function is to check user activity
function check() {
    const now = Date.now();
    if (now - lastTime >= 5000000000000) { 
        window.location.href = "/login/";
    } else {
        reset();
    }
}

function activity() {
    lastTime = Date.now(); 
    if (displayed) {
        const div = document.getElementById('confirmationDiv');
        if (div) {
            document.body.removeChild(div);
        }
        displayed = false;
    }
    if (paused) {
        paused = false;
    }
    reset(); 
}

function reset() {
    clearTimeout(timeout);
    timeout = setTimeout(check, 6000000000000); 
}

document.addEventListener('mousemove', activity);
document.addEventListener('keydown', activity);

lastTime = Date.now();
reset();
document.addEventListener('DOMContentLoaded', function () {
    // Change Terminal Font Color
    document.getElementById('font-color-picker').addEventListener('input', function () {
        const colorValue = this.value; // Capture the value to use inside forEach
        document.querySelectorAll('.terminal-text').forEach(element => {
            element.style.color = colorValue;
        });
    });

    // Change Background Color
    document.getElementById('background-color-picker').addEventListener('input', function () {
        document.body.style.backgroundColor = this.value;
    });

    // Change Terminal Background Color
    document.getElementById('terminal-background-color-picker').addEventListener('input', function () {
        const terminalContainer = document.querySelector('.terminal-container');
        terminalContainer.style.backgroundColor = this.value;
    });

    // Change Font Family
    document.getElementById('font-family-picker').addEventListener('change', function () {
        const fontFamilyValue = this.value; // Correctly capturing the value
        document.querySelectorAll('.terminal-text').forEach(element => {
            element.style.fontFamily = fontFamilyValue;
        });
    });
});

// Start of battle functionalities
// Calculates enemy's strength, it is randomized by the basa damage, i.e. 5
function enemyStrength() {
    const dmg = 5; 
    const randomProb = Math.random();
    const damage = Math.floor(dmg * randomProb);
    return damage;
}

// Calculates the probability of enemy's attack connecting user
function enemyAttack() {
    const probHit = 0.6;
    const randomHit = Math.random();
    if (randomHit < probHit) {
        const damage = enemyStrength();
        //if enemy's attack hits
        return {
            hit: true,
            damage: damage
        };
    } //if enemy's attack misses 
    else {
        return {
            hit: false,
            damage: 0
        };
    }
}

// Calculates the user's strength(how much dmg to do to enemy) randomized as well times base dmg
function userStrength() {
    const dmg = 10;
    const randomProb = Math.random();
    const damage = Math.floor(dmg * randomProb);
    return damage;
}

// Main battle function
async function battle(userHP, enemyHP, callback) {
    await animNarrate(" ", "{% static 'main/images/battleStart.gif' %}", 600, 600);
    await narrate("Battle Start!");
    while (userHP > 0 && enemyHP > 0) {
        const attackChoice = await promptChoice("Attack?", [
            { label: "Attack", value: "z" },
            { label: "Stay still", value: "x" }
        ]);
// Attack
        if (attackChoice === "z") {
            const userStr = userStrength();
            const statEnemy = enemyAttack();
            enemyHP -= userStr;
            if (enemyHP < 0) {
                enemyHP = 0;
            }
            userHP -= statEnemy.damage;
            if (userHP < 0) {
                userHP = 0;
            }
            //Attack hits
            if (userStr > 0) {
                await playSound("{% static 'main/sounds/sword-swing.wav' %}")
                await animNarrate(" ", "{% static 'main/images/attack.gif' %}");
                await narrate("Your attack connects, and does " + userStr + " hit points to the enemy! Enemy Health is: " + enemyHP + " points.");
            } 
            //Attack misses
            else 
            {
                await playSound("{% static 'main/sounds/miss.mp3' %}")
                await narrate("Your attack didn't connect to the enemy! Enemy Health is: " + enemyHP + " points.");
            }

            //Enemy's attack hits
            if (statEnemy.hit) {
                await narrate("The enemy attack hits you, and does " + statEnemy.damage + " hit points to you! Your HP is: " + userHP + " points.");
            } 
            //Enemy's attack misses
            else {
                await narrate("Enemy's attack misses! Your HP is: " + userHP + " points.");
            }
            //User's HP reaches 0, game over.
            if (userHP <= 0) {
                await narrate("Your health reached 0, you're dead. GAME OVER");
                await narrate("Do you want to restart, or exit the game?");

                await narrate("----------------------------------------------------------------");
                await narrate("Options: z = Restart | x = Exit");
                await narrate("----------------------------------------------------------------");

                const statusRestart = await promptChoice("Do you want to restart, or exit the game?",
                    [
                        { label: "Restart", value: "z" },
                        { label: "Exit", value: "x" }
                    ]);

                if (statusRestart === "z") {
                    saveGameState(0);
                    await beginning();
                } else if (statusRestart === "x") {
                    exit();
                } else {
                    await narrate("Not a valid option, please try again!.");
                }
            }

            if (enemyHP <= 0) {
                await narrate("Success, you won the battle!");
                if (callback) {
                    await callback();
                    //calls another function that serves as the continuation of what happened in the story after the battle.
                }
            }
        } 
        //stay still
        else if (attackChoice === "x") {
            await playSound("{% static 'main/sounds/swish.wav' %}")
            await animNarrate(" ", "{% static 'main/images/stayStill.gif' %}");
            await narrate("You chose not to attack. The enemy makes a move.");
            const statEnemy = enemyAttack();
            userHP -= statEnemy.damage;
            if (userHP < 0) {
                userHP = 0;
            }
            if (statEnemy.hit) {
                await narrate("The enemy attack hits you, and does " + statEnemy.damage + " hit points to you! Your HP is: " + userHP + " points.");
            } else {
                await narrate("Enemy's attack misses!");
            }

            if (userHP <= 0) {
                await narrate("Your health reached 0, you're dead. GAME OVER");
                await narrate("Do you want to restart, or exit the game?");

                await narrate("----------------------------------------------------------------");
                await narrate("Options: z = Restart/x = Exit");
                await narrate("----------------------------------------------------------------");

                const statusRestart = await promptChoice("Do you want to restart, or exit the game?",
                    [
                        { label: "Restart", value: "z" },
                        { label: "Exit", value: "x" }
                    ]);

                if (statusRestart === "z") {
                    saveGameState(0);
                    await beginning();
                } else if (statusRestart === "x") {
                    exit();
                } else {
                    await narrate("Not a valid option, please try again!.");
                }
            }
        }
//Stops narraration for a bit
        await new Promise((resolve) => {
            setTimeout(() => {
                resolve();
            }, 1000);
        });
    }
}
    const commands = ["z", "x", "c", "v", "b"];
//function for when the user clicks the Go Left button in the beginning, takes the user to the left of the starting area
    async function leftTree() 
    {
    let choiceUser = "";
    while (!commands.includes(choiceUser)) 
    {
        await narrate("You decide to go to the left in order to see the trail surrounded by blue trees. Going down this trail you realize that you hear suspicious sounds. Some of them sound like human children voices. You are a little frightened but you keep moving forward. Suddenly however, there is a fork in the road.");
        await narrate("Which direction do you want to go, Left or right?");

        await narrate("----------------------------------------------------------------");
        await narrate("Options: z = Go left/x = Go right");
        await narrate("----------------------------------------------------------------");

        const choiceUser = await promptChoice("Which direction do you want to go?", [
            { label: "Go left", value: "z" },
            { label: "Go right", value: "x" }
        ]);

        if (choiceUser === "z") 
        {
            await narrate("You decide to go left. You see a lakebed but there's no water in it. You feel that there is something behind you. Before you can turn, however, you feel a sharp pain in your head. You've been hit.");
            await narrate("*PATH 1 OVER*");
            await narrate("*BAD ENDING 1*");
            await narrate("Do you want to restart, or exit the game?");

            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Restart/x = Exit");
            await narrate("----------------------------------------------------------------");

            const statusRestart = await promptChoice("Do you want to restart, or exit the game?", [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
            ]);

            if (statusRestart === "z") 
            {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x") 
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
        } else if (choiceUser === "x") {
            await narrate("You decide to go right. The trail leads you to a small hut. There is an extremely tall figure standing in front of it. It speaks in a raspy tone.");
            await narrate("STRANGE FIGURE: You have done well " + name + " to find me. Do not worry. All will make sense, in due time.");
            await narrate("The strange figure vanishes. You have a thousand questions and thoughts in your head, but the one thing that questions you is, how did it know your name? Nonetheless, you move into the hut. What is in the hut, is a story for another time...");
            await narrate("*PATH 2 OVER*");
            await narrate("*GOOD ENDING 1*");
            await narrate("Do you want to restart, or exit the game?");

            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Restart/x = Exit");
            await narrate("----------------------------------------------------------------");

            const statusRestart = await promptChoice("Do you want to restart, or exit the game?", [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
            ]);

            if (statusRestart === "z") 
            {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x")
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
        } 
        else 
        {
            await narrate("Not a valid option, please try again!.");
        }
    }
}
//function for when the user clicks the Go Forward button in the beginning, takes the user to the front of the starting area

async function frontTrain() {
    let choiceUser = "";
    while (!commands.includes(choiceUser)) {
        await narrate("You decide to go front and see the remains of the train. You see in the train that the driver is unconscious. You are not sure if he is asleep, incapacitated, or dead. Do you want to check his pulse?");

        await narrate("--------------------------------------------------------------------------------------------------");
        await narrate("Options: z = Check his pulse/x = Leave him alone and search elsewhere");
        await narrate("--------------------------------------------------------------------------------------------------");

        const choiceUser = await promptChoice("Do you want to check his pulse?", [
            { label: "Check his pulse", value: "z" },
            { label: "Leave him alone and search elsewhere", value: "x" }
        ]);

        if (choiceUser === "z") 
        {
            await narrate("You check the driver's pulse. It is faint, but it is still there. The driver is still alive, but you do not know what happened to him. You return back to the rest of the train and look for any other passengers. Everyone is still there but they are all also unconscious it seems. You are tired from exploring so you take a rest in one of the empty seats.");
            await narrate("*PATH 3 OVER*");
            await narrate("*BAD ENDING 2*");
            await narrate("Do you want to restart, or exit the game?");

            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Restart/x = Exit");
            await narrate("----------------------------------------------------------------");

            const statusRestart = await promptChoice("Do you want to restart, or exit the game?", [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
            ]);

            if (statusRestart === "z") 
            {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x") 
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
        } 
        else if (choiceUser === "x") 
        {
            await narrate("You decide to leave him alone, you are uneasy to go near his body. You return back to the rest of the train and look for any other passengers. Everyone is still there but they are all also unconscious it seems. You are tired from exploring so you take a rest in one of the empty seats.");
            await narrate("*PATH 4 OVER*");
            await narrate("*BAD ENDING 3*");
            await narrate("Do you want to restart, or exit the game?");

            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Restart/x = Exit");
            await narrate("----------------------------------------------------------------");

            const statusRestart = await promptChoice("Do you want to restart, or exit the game?", [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
            ]);

            if (statusRestart === "z") 
            {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x") 
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
        }
         else 
        {
            await narrate("Not a valid option, please try again!.");
        }
    }
}
//function for when the user clicks the Go Right button in the beginning, takes the user to the right of the starting area

async function rightCave() {
    let choiceUser = "";
    while (!commands.includes(choiceUser)) {
        await narrate("You decide to head into the cave to the right. It is extremely dark, and there are no sources of light around. Your phone doesn't have any signal but it can still use flash, so you use it as a flashlight and are looking around. There are paintings on the wall, they look like caveman drawings and seem to be very old. You deduce that this used to be a place where people used to live. You see a makeshift staircase with two ways, up and down. Which way do you go?");

        await narrate("----------------------------------------------------------------------------------");
        await narrate("Options: z = Go up the stairs/x = Go down the stairs");
        await narrate("----------------------------------------------------------------------------------");

        const choiceUser = await promptChoice("Which way do you go?", [
            { label: "Go up the stairs", value: "z" },
            { label: "Go down the stairs", value: "x" }
        ]);

        if (choiceUser === "z") 
        {
            await narrate("You decide to go up the stairs. Here there seem to be a lot of interesting creatures such as bats and snails. You hear something dangerous however.");
            await narrate("*HISSSSSSSSSSSSSSSSSSSSSS*");
            await narrate("An intense pain shoots up your leg. It seems that a snake has bitten you, and it is venomous. The pain goes instantly across your body and you are immobilized. Perhaps you'll be able to secure this business deal... in another life.");
            await narrate("*PATH 5 OVER*");
            await narrate("*BAD ENDING 4*");

            await narrate("Do you want to restart, or exit the game?");

            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Restart/x = Exit");
            await narrate("----------------------------------------------------------------");

            const statusRestart = await promptChoice("Do you want to restart, or exit the game?", [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
            ]);

            if (statusRestart === "z")
             {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x") 
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
        } 
        else if (choiceUser === "x")
         {
            await narrate("You decide to go downstairs. It's even darker but you can still make your way around the surroundings. You see what seems to be wooden children's toys. It was a family living here. Amidst all of this strange antiquated furniture, you see something very shocking. A TV. It isn't connected to anything, but flickers open and starts playing a blurry video with text on it. The text reads: ");
            await narrate("*DO YOU WANT TO PLAY A GAME " + name + "? HAHAHAHAHAAAA");
            await narrate("You feel a sense of familiarity with this text. Do you know anyone who writes like this? How does the TV know your name? All will be answered in due time...");
            await narrate("*PATH 6 OVER*");
            await narrate("*GOOD ENDING 2*");

            await narrate("Do you want to restart, or exit the game?");

            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Restart/x = Exit");
            await narrate("----------------------------------------------------------------");

            const statusRestart = await promptChoice("Do you want to restart, or exit the game?", [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
            ]);

            if (statusRestart === "z") 
            {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x") 
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
        } 
        else {
            await narrate("Not a valid option, please try again!.");
        }
    }
}
//function for when the user clicks the Go Behind button in the beginning, takes the user to the back of the starting area

async function behindTrail() {
    await narrate("You decide to go behind you to the trail. Before you can even blink, there is an enemy that attacks you.You are scared but you realize what is on the line. You think to yourself and become confident again. You say loudly: ");
    await narrate("NAH, I'D WIN!");
    await narrate("You are now in a battle.");
    await animNarrate(" ", "{% static 'main/images/mystery.png' %}", 500, 500);
    let userHP, enemyHP;
    switch (gameMode) {
        case "1": // Easy
            userHP = 100;
            enemyHP = 25;
            break;
        case "2": // Medium
            userHP = 50;
            enemyHP = 50;
            break;
        case "3": // Hard
            userHP = 30;
            enemyHP = 50;
            break;
        default:
            userHP = 50;
            enemyHP = 50;
            console.log("Falling back to default game mode settings.");
            break;
    }
    saveGameState(6);
    updateProgressBar(myProgressBar, completion);
    await battle(userHP, enemyHP, behindTrail2);
    
}

//function for when the user clicks the Stay button in the beginning, takes the user to the left of the realm that has been generated

async function realmLeft()
{   
    await narrate("You decided to go left into the realm. You don't seem to be alone, but you are surprised by an extremely large rabbit resembling being. You find the nearest thing, a chair, and fold it in order to use it as a weapon.")
    await narrate("RABBIT: They call me Selman, I'm a car driver. You have entered my territory, I have no respect for you, you seem to be extra goofy looking. If you don't scurry off I will be forced to attack you, gee wilkers!");
    await animNarrate(" ", "{% static 'main/images/rabbit.png' %}", 500, 500);
    await narrate("You are now in a battle.")
    let userHP, enemyHP;
    switch (gameMode) {
        case "1": // Easy
            userHP = 100;
            enemyHP = 25;
            break;
        case "2": // Medium
            userHP = 50;
            enemyHP = 50;
            break;
        case "3": // Hard
            userHP = 30;
            enemyHP = 50;
            break;
        default:
            userHP = 50;
            enemyHP = 50;
            console.log("Falling back to default game mode settings.");
            break;
    }
    saveGameState(9);
    updateProgressBar(myProgressBar, completion);
    await battle(userHP, enemyHP, realmLeft2);
    

}
//function for when the user clicks the Stay button in the beginning, takes the user to the right of the realm that has been generated
async function realmRight()
{
    await narrate("You decided to go right into the realm. Suddenly a flash of memories flashes your mind. It is all the other timelines that you have experienced til now. You understand the plight of humanity and you understand what to do now, face Legoat, beat him, and end this era of tyranny!")
    await narrate("As you hurry down, you see a throne. It has what seems to be fake rings all over it and a giant mouse costume. It seems all these rings are stolen. You think to yourself, Legoat must be a fraud if he can't get any real rings. As soon as you think that, he comes in front of you.");
    await narrate("LEGOAT: *Ahhh yes it is finally time to challenge you, for the fate of humanity! Previously I had all these fake rings, but you possess the real ring. Once I defeat you I will take the ring for myself and be the king of the demi-beings! HAVE AT YOU!!!!!!!!*");
    await animNarrate(" ", "{% static 'main/images/goat.png' %}", 500, 500);
    await narrate("You are now in a battle.")

    let userHP, enemyHP;
    switch (gameMode) {
        case "1": // Easy
            userHP = 100;
            enemyHP = 50;
            break;
        case "2": // Medium
            userHP = 50;
            enemyHP = 75;
            break;
        case "3": // Hard
            userHP = 30;
            enemyHP = 75;
            break;
        default:
            userHP = 50;
            enemyHP = 50;
            console.log("Falling back to default game mode settings.");
            break;
    }
    saveGameState(10);
    updateProgressBar(myProgressBar, completion);
    await battle(userHP, enemyHP, realmRight2);
    

}
//function for when the user clicks the Stay button in the beginning, gives the user the choice to go to realmRight() or realmLeft()

        async function stayHelp()
        {
        await narrate("You decided to stay back, and wait for help. Hours seemed to pass by but no one came by. You decided to shut your eyes for some sleep. You wake up in a strange realm. It seems that you aren't on earth anymore. You are on a forking road in this realm. Everything is white around. Do you want to go right, or do you want to go left?");
        await narrate("Where do you go?");
            
        await narrate("----------------------------------------------------------------------------------");
        await narrate("Options: z = Go left/x = Go right");
        await narrate("----------------------------------------------------------------------------------");

        const choiceUser = await promptChoice("Where do you go?", [
            { label: "Go left", value: "z" },
            { label: "Go right", value: "x" }
        ]);

        if (choiceUser === "z")
        {
            saveGameState(7);
            updateProgressBar(myProgressBar, completion);
            await realmLeft();
        }

        if (choiceUser === "x")
        {
            saveGameState(8);
            updateProgressBar(myProgressBar, completion);
            await realmRight();
        }

        }

//function for beginning the game

        async function beginning() {
            await animNarrate(" ", "{% static 'main/images/start.gif' %}");
            await narrate("You are traveling on the Shattered Rails Express. You are on your way to an important meeting that'll change your career. You absolutely cannot miss this meeting, but the Shattered Rails Express is completely infallible.");
            await narrate("You know this fact, but you still feel a little uneasy. Everything should be fine though, there's no way anything can go wrong...right?");
            await narrate("*CRASH*");
            await narrate("You hear a loud sound, and everything turns to black, and you faint. You wake up again on the ground of a mysterious forest. You try to check your phone and other electronics but all their signals are cut. You look up and see 4 things around you immediately: A trail to the left surrounded by blue trees, the ruins of a wrecked Shattered Rails Express in front of you, a cave to the right of you, and a trail of blood behind you. You also can choose to stay back for help.");
            await narrate("Where do you want to go?");

                await narrate("---------------------------------------------------------------------------------------------------------------------------------------------------------------------------");
                await narrate("Options: z = Go left into the trail with the blue trees/x = Go forward and check the train/c = Go right into the cave/v = Go behind to the trail of blood/b = Stay for help");
                await narrate("---------------------------------------------------------------------------------------------------------------------------------------------------------------------------");

                const choiceUser = await promptChoice("Where do you want to go?", 
                [
                { label: "Go left", value: "z" },
                { label: "Go forward", value: "x" },
                { label: "Go right", value: "c" },
                { label: "Go behind", value: "v" },
                { label: "Stay", value: "b" }
                ]  
                );
                //Go left
                if (choiceUser === "z") {
                    saveGameState(1);
                    updateProgressBar(myProgressBar, completion);
                    
                    await leftTree();
                //Go forward
                } else if (choiceUser === "x") {
                    saveGameState(2);
                    updateProgressBar(myProgressBar, completion);
                    
                    await frontTrain();
                //Go right
                } else if (choiceUser === "c") {
                    saveGameState(3);
                    updateProgressBar(myProgressBar, completion);
                    
                    await rightCave();
                } 
                //Go behind
                else if (choiceUser === "v")
                {
                    saveGameState(4);
                    updateProgressBar(myProgressBar, completion);
                    
                    await behindTrail();
                }
                //Stay
                else if (choiceUser === "b")
                {
                    saveGameState(5);
                    updateProgressBar(myProgressBar, completion);
                    console.log("Your currently on save state "+ save_state)  //Save state 5
                    await stayHelp();
                }
                else 
                {
                    await narrate("Not a valid option, please try again!.");
                }
            
        }
        
//Function for outputting text with a delay
        async function narrate(script) {
            return new Promise(resolve => {
                let start = 0;
                const outputDiv = document.getElementById("output");
                const contTerm = document.querySelector(".terminal-container");
                const speechEnabled = document.getElementById("speechToggle").checked;
                const cleanScript = script.replace(/={3,}/g, ", ");

                if ('speechSynthesis' in window && speechEnabled) {
                    const utterance = new SpeechSynthesisUtterance(script);
                    window.speechSynthesis.speak(utterance);
                }
                else {
                    console.error("Speech sythesis not supported");
                }
                const intervalId = setInterval(() => {
                    if (!pauseStatus) {
                        outputDiv.innerHTML += script[start];
                        contTerm.scrollTop = contTerm.scrollHeight;

                        start += 1;
                        if (start === script.length) {
                            clearInterval(intervalId);
                            outputDiv.innerHTML += '<br><br>';
                            contTerm.scrollTop = contTerm.scrollHeight;
                            resolve();
                        }
                    }
                }, textSpeed);
            });
        }

//tutorial function
    async function tutorial() 
    {
    await narrate("Hello, and welcome to Shattered Rails! This is the tutorial to the game.");
    await narrate("Throughout this game, you will encounter scenarios that will ask you for your input to further the game. All you have to do is enter the corresponding option for the choice, to go down that path. There'll be options presented, alongside with their alphabetical inputs correlating to that decision.");
    await narrate("Here is an example:");
    await narrate("You are in a strange space and you see two directions around you, do you want to go left, or right?");
    await narrate("----------------------------------");
    await narrate("Options: z = Go left /x = Go right");
    await narrate("----------------------------------");
    await narrate("From here on, all you'd need to do is choose which choice to choose and see the results!");
    await narrate("\nFor the battle scenarios, there are 2 options, Attack or Stay Still. Stay Still doesn't inflict any damage but attack does! Based on which difficulty you selected at the beginning(Easy/Medium/Hard), your HP(Health Points) will be adjusted accordingly. Easy mode has the user HP as 100 and enemy as 25, Medium has user HP as 50 and enemy at 25, and Hard has user HP as 30 and enemy as 50.");
    await narrate("\nThus concludes the tutorial, would you like to read this again?");
    await narrate("----------------------------------");
    await narrate("Options: z = Play Game /x = Reread");
    await narrate("----------------------------------");

    const choiceUser = await promptChoice("Thus concludes the tutorial, would you like to read this again?", [
        { label: "Play Game", value: "z" },
        { label: "Reread", value: "x" }
    ]);

    if (choiceUser === "z") {
        await beginning(); 
    } else if (choiceUser === "x") {
        await tutorial();
    }
}

//main function
async function main() {
    console.log(completion);
    updateProgressBar(myProgressBar, completion);
    if(save_state >= 1) {
        if(save_state == 1) {
            leftTree();
        }
        else if(save_state == 2) {
            frontTrain();
        }
        else if(save_state == 3) {
            rightCave();
        }
        else if(save_state == 4) {
            behindTrail();
        }
        else if(save_state == 5) {
            stayHelp();
        }
        else if(save_state == 6) {
            behindTrail2();
        }
        else if(save_state == 7) {
            realmLeft();
        }
        else if(save_state == 8) {
            realmRight();
        }
        else if(save_state == 9) {
            realmLeft2()
        }
        else if(save_state == 10) {
            realmRight2();
        }
        else {
            return 0;
        }
    }
//setting up game options at beginning
    else {
        await narrate("--------------------------------------------");
        await narrate("Hello, welcome to Shattered Rails 1.");
        await narrate("Please input a name: ");

        const userNameInp = () => {
            document.getElementById("name-input-container").innerHTML = "<input style='background-color: black; border-radius: 20px; margin: 0 10px; color: white; margin-bottom: 20px' type='text' id='name' placeholder='Enter your name'>";
        };
        userNameInp();
        const userNamePromise = new Promise(resolve => {
            document.getElementById("name").addEventListener("change", () => {
                resolve(document.getElementById("name").value.trim());
            });
        });

        const nameInput = await userNamePromise;
        document.getElementById("name-input-container").innerHTML = "";

        name = nameInput || "Akira";

        await narrate(`Your name is: ${name}.`);

        await narrate("Before starting this game, please choose the game mode:");

        await narrate("---------------------------------------------------------------------");
        await narrate("Options: 1 = Easy / 2 = Medium / 3 = Hard");
        await narrate("---------------------------------------------------------------------");

        gameMode = await promptChoice("---------------------------------------------------------------------", [
            { label: "Easy", value: "1" },
            { label: "Medium", value: "2" },
            { label: "Hard", value: "3" }
        ]);

        let userHP, enemyHP;
        switch (gameMode) {
            //Easy
            case "1":
                userHP = 100;
                enemyHP = 25;
                break;
            //Medium
            case "2":
                userHP = 50;
                enemyHP = 25;
                break;
            //Hard
            case "3":
                userHP = 30;
                enemyHP = 50;
                break;
            default:
                console.log("Invalid option selected. Default Medium")
                userHP = 50;
                enemyHP = 25;
                break;
        }

        const choiceUser = await promptChoice("Before starting this game, would you want to see the tutorial for Shattered Rails?", [
            { label: "Play Game", value: "z" },
            { label: "See Tutorial", value: "x" }
        ]);

        if (choiceUser === "z") {
            saveGameState(0);
            await beginning();
        } else if (choiceUser === "x") {
            await tutorial();
        } else {
            await narrate("Not a valid option, please try again!.");
        }
        }
    
}

        main();

        // Function to change line spacing
document.getElementById("line-spacing-picker").addEventListener("input", function () {
    const lineSpacingValue = this.value;
    const terminalText = document.querySelector('.terminal-text');
    terminalText.style.lineHeight = lineSpacingValue;


        // Function to change background color
        document.getElementById("background-color-picker").addEventListener("input", function () {
            document.body.style.backgroundColor = this.value;
        });

        // Function to change font color
        document.getElementById("font-color-picker").addEventListener("input", function () {
            document.querySelector('.terminal-text').style.color = this.value;
        });

        // Function to change terminal background color
        document.getElementById("terminal-background-color-picker").addEventListener("input", function () {
            document.querySelector('.terminal-container').style.backgroundColor = this.value;
        });

        // Function to change font family
        document.getElementById("font-family-picker").addEventListener("change", function () {
            const selectedFont = this.value;
            document.querySelector('.terminal-text').style.fontFamily = selectedFont;
            document.querySelector('.logout-button').style.fontFamily = selectedFont;
            document.querySelector('.speed-slider').style.fontFamily = selectedFont;
            document.querySelector('.help-button').style.fontFamily = selectedFont;

        });
    });

    // Save the current checkpoint and send to backend to store in db
    async function saveGameState(save_state) {
        const data = JSON.stringify({ 'save_state': save_state });

        fetch('/save_game_state/', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken') 
            },
            body: data
        })
        .then(response => response.json())
        .then(data => console.log('Game state saved successfully:', data))
        .catch(error => console.error('Error saving game state:', error));
    }

    function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
//After behindTrail's battle is finished
async function behindTrail2() 
    {
        await narrate("Congrats, you beat the enemy and keep moving forward back into the trail! You see a mysterious fog, and it asks you something: ");
        await narrate("STRANGE VOICE: *Well done traveler, you have defeated the enemy causing all the destruction and mayhem in these woods. Would you like to hear the truth about what has happened during your journey? Be forewarned, as the truth might be too much for you to handle. You might not be alive afterwards,*");
        await narrate("----------------------------------------------------------------------------------");
        await narrate("Options: z = Hear the Truth/x = Refuse the offer");
        await narrate("----------------------------------------------------------------------------------");

        const choiceUser = await promptChoice("----------------------------------------------------------------------------------", [
            { label: "Hear Truth", value: "z" },
            { label: "Refuse Offer", value: "x" }
        ]);

        if (choiceUser === "z") 
        {
            await narrate("You decide to hear the truth.");
            await narrate("STRANGE VOICE: *Very good, that was an extremely sigma decision of you. This forest is this way due to humanity being cringe, and destroying the earth. We have decided to punish you mortals by entering this sacred space. But you are different, you aren't cringe, you are a signma lone wolf. You have been in a time loop this whole time taking different choices but you have made the right choice this time. It seems that you should become one of our kind of demi-gods and punish any cringe mortals that anger our solar system.*");
            await narrate("Accept offer?");
            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Accept offer/x = Refuse");
            await narrate("----------------------------------------------------------------");

            const choiceUser = await promptChoice("-----------------------------------------------------------------", [
                { label: "Accept Offer", value: "z" },
                { label: "Refuse", value: "x" }
            ]);

            if (choiceUser === "z") 
            {
            await narrate("STRANGE VOICE: *Well done, you have become one of us!*");
            await narrate("*PATH 7 OVER*");
            await narrate("*GOOD ENDING 3*");

            await narrate("Do you want to restart, or exit the game?");

            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Restart/x = Exit");
            await narrate("----------------------------------------------------------------");

            const statusRestart = await promptChoice("Do you want to restart, or exit the game?", [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
            ]);

            if (statusRestart === "z") 
            {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x") 
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
            } 
            else if (choiceUser === "x")
             {
                await narrate("STRANGE VOICE: *Oh well, it seems that you have chosen the way of a cringe man. Who am I to judge, live in mediocrity then.*");
                await narrate("It seems the fog has disappated and you see a path back to a nearby town. You can finally go back to normalcy but you wonder about the fate of humanity. Oh well, it's not your job.")
                await narrate("*PATH 8 OVER*");
                await narrate("*GOOD ENDING 4*");

            await narrate("Do you want to restart, or exit the game?");

            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Restart/x = Exit");
            await narrate("----------------------------------------------------------------");

            const statusRestart = await promptChoice("Do you want to restart, or exit the game?", [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
            ]);

            if (statusRestart === "z") 
            {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x") 
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
        } 
        else if (choiceUser === "x") 
        {
            await narrate("STRANGE VOICE: *You decided not to hear the truth? I gave you a path to see if humanity would beat their ignorance but it seems I was too forgiving. You are cringe like the rest of them. You don't deserve to live!*");
            await narrate("You are electrocuted but at that moment everything gets rushed back to you, it seems that you have gone down these paths before and it is infinite. Maybe next time you'll choose the right choices. For now though, your journey has came to an end.")
            await narrate("*PATH 9 OVER*");
            await narrate("*BAD ENDING 5*");

            await narrate("Do you want to restart, or exit the game?");

            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Restart/x = Exit");
            await narrate("----------------------------------------------------------------");

            const statusRestart = await promptChoice("Do you want to restart, or exit the game?", [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
            ]);

            if (statusRestart === "z") 
            {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x")
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
        } 

        else 
        {
            await narrate("Not a valid option, please try again!.");
        }
    }

    //After realmLeft's battle is finished

    async function realmLeft2() 
    {
        await narrate("Congrats, you beat Selman. It speaks to you: ");
        await narrate("SELMAN: *You have beaten me but I don't sense any hate in you. The reason I am here is because the demigod Legoat banished me to this realm. You have probably heard his voice before, he is the strange voice speaking always. He is my enemy, and is yours too. I hope you defeat him and save humanity. Will you do so?*");
        await narrate("What will you say to him?");
        await narrate("----------------------------------------------------------------------------------");
        await narrate("Options: z = I will/x = I will not");
        await narrate("----------------------------------------------------------------------------------");

        const choiceUser = await promptChoice("----------------------------------------------------------------------------------", [
            { label: "I will", value: "z" },
            { label: "I will not", value: "x" }
        ]);

        if (choiceUser === "z") 
        {
            await narrate("Thank you! However, you will have to do this in another timeline. You see, this forest and realm you cannot escape, however, we are stuck in a time loop until Legoat is defeated. Try again later, my friend!");
            await narrate("LEGOAT: *You fools, I am the protector of this realm and of the demi-beings, you will never be able to defeat me! However, I see that you are extremely powerful, it seems you know the ways of being sigma and based. Would you like to join my legion of fedora wearing demi-beings??*");
            await narrate("Accept offer?");
            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Accept offer/x = Refuse");
            await narrate("----------------------------------------------------------------");

            const choiceUser = await promptChoice("-----------------------------------------------------------------", [
                { label: "Accept Offer", value: "z" },
                { label: "Refuse", value: "x" }
            ]);

            if (choiceUser === "z") 
            {
            await narrate("LEGOAT: *Well done, you made the right decision. You have become one of us!*");
            await narrate("You are brimming with power, however you ponder whether you made the right decision. Oh well, you always have another timeline to do the right thing.");
            await narrate("*PATH 10 OVER*");
            await narrate("*SPECIAL ENDING 1*");

            await narrate("Do you want to restart, or exit the game?");
            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Restart/x = Exit");
            await narrate("----------------------------------------------------------------");

            const statusRestart = await promptChoice("Do you want to restart, or exit the game?", [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
            ]);

            if (statusRestart === "z") 
            {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x") 
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
            } 
            else if (choiceUser === "x")
             {
                await narrate("LEGOAT: *Oh well, it seems that you have chosen the way of a cringe man. Who am I to judge, live in mediocrity then.*");
                await narrate("It seems the voice has disappated, but you will be here with Selman for the rest of eternity. It is okay though, as you will defeat Legoat in another timeline!")
                await narrate("*PATH 11 OVER*");
                await narrate("*SPECIAL ENDING 2*");
                await narrate("Do you want to restart, or exit the game?");

                await narrate("----------------------------------------------------------------");
                await narrate("Options: z = Restart/x = Exit");
                await narrate("----------------------------------------------------------------");

                const statusRestart = await promptChoice("Do you want to restart, or exit the game?",
                [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
                ]);

            if (statusRestart === "z") 
            {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x") 
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
        } 
        else if (choiceUser === "x") 
        {
            await narrate("SELMAN: *Why must you be this way? I do not understand you humans, with your social media apps and dance challenges. Our generation was so much better smh. Stop looking out for yourself with your yolos and your cringes and start thinking about the future of our universe! You are not cooking with this one chief let me tell you that about this indubitable situation. You want to know how I got these scars? My father was a gamer just like you.*");
            await narrate("SELMAN: *It is because of my father being a gamer and being addicted to fast food and watching sports on our tv that I became a car driver around the footpaths. Humanity is so self serving. I was the embodiment of hope and I thought you would destroy this circle of hedonism and selfishness and achieve nirvana. Seems that it is way too early for another era, we have to wait for another timeline's incarnation.*");
            await narrate("*PATH 12 OVER*");
            await narrate("*BAD ENDING 6*");

            await narrate("Do you want to restart, or exit the game?");
            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Restart/x = Exit");
            await narrate("----------------------------------------------------------------");

            const statusRestart = await promptChoice("Do you want to restart, or exit the game?", [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
            ]);

            if (statusRestart === "z") 
            {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x")
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
        } 

        else 
        {
            await narrate("Not a valid option, please try again!.");
        }
    }
    //After realmRight's battle is finished

    async function realmRight2() 
    {
        await narrate("VICTORY ROYALE!!! LEFRAUD HAS BEEN BEATEN, "+ name + " IS LEGOAT'S FATHER!!!");
        await narrate("Legoat turns back into his true original form, a small mouse being");
        await narrate("LEGOAT: *NOOOOOOO PLEASE LET ME LIVE!!! I WILL BE ABLE TO REVERT EVERYTHING BACK TO NORMAL!*");
        await narrate("Will you spare him?");
        await narrate("----------------------------------------------------------------------------------");
        await narrate("Options: z = Spare/x = Don't Spare");
        await narrate("----------------------------------------------------------------------------------");

        const choiceUser = await promptChoice("Will you spare him?", [
            { label: "Spare", value: "z" },
            { label: "Don't Spare", value: "x" }
        ]);

        if (choiceUser === "z") 
        {
            await narrate("LEGOAT: Thank you! Here I will turn everything back to normal: ");
            await narrate("WHOOOOOOOOOOOOSH");
            await narrate("Everything is back to normal, the train is back on the rails, all the passengers are back to normal. But you see Legoat running way")
            await narrate("LEGOAT: *You fool, I am the protector of this realm and of the demi-beings, you will never be able to defeat me!*");
            await narrate("Since Legoat is only a mouse now, you can choose to spare him, as he won't do anything, but will you?")
            await narrate("Spare him?");
            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Spare/x = Don't Spare");
            await narrate("----------------------------------------------------------------");

            const choiceUser = await promptChoice("----------------------------------------------------------------=", [
                { label: "Spare", value: "z" },
                { label: "Don't Spare", value: "x" }
            ]);

            if (choiceUser === "z") 
            {
            await narrate("You decide to let Legoat go. What can a mouse do? You get back on the train, and go your merry way. You will make it to your meeting and everything will be alright... or you think?? Perhaps the rails have been truly unshattered.");
            await narrate("*PATH 13 OVER*");
            await narrate("*GOOD ENDING 6*");

            await narrate("Do you want to restart, or exit the game?");
            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Restart/x = Exit");
            await narrate("----------------------------------------------------------------");

            const statusRestart = await promptChoice("Do you want to restart, or exit the game?", [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
            ]);

            if (statusRestart === "z") 
            {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x") 
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
            } 
            else if (choiceUser === "x")
        {
                await narrate("You decide to eliminate Legoat.");
                await narrate("It seems he is gone, and everything should be fine now. You go on your merry way, but you do wonder about the other demi-beings. Legoat said that he was the king. What will happen once the king is gone? Perhaps thats another story as you go back onto the Shattered Rails express and go back to your meeting!")
                await narrate("*PATH 14 OVER*");
                await narrate("*GOOD ENDING 7*");

                await narrate("Do you want to restart, or exit the game?");

                await narrate("----------------------------------------------------------------");
                await narrate("Options: z = Restart/x = Exit");
                await narrate("----------------------------------------------------------------");

                const statusRestart = await promptChoice("Do you want to restart, or exit the game?",
                [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
                ]);

            if (statusRestart === "z") 
            {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x") 
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
        }
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
        } 

        else if (choiceUser === "x") 
        {
            await narrate("You decide to not spare Legoat. He disappears, and you are left with the throne. You have the power to turn back everything and unshatter the rails... or you can have unlimited power as the ruler of this realm... what to do?");
            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Rule/x = Turn Back");
            await narrate("----------------------------------------------------------------");

            const choiceUser = await promptChoice("-----------------------------------------------------------------", [
                { label: "Rule", value: "z" },
                { label: "Turn Back", value: "x" }
            ]);

            if (choiceUser === "z") 
            {
            await narrate("You decide to take the throne and the power. After all, you did beat Legoat, meaning that you are the rightful heir to the throne. You spend the rest of your days ruling all realms, and waging wars against humanity whilst enjoying being the king of all the demi-beings.");
            await narrate("*PATH 15 OVER*");
            await narrate("*SPECIAL ENDING 4*");

            await narrate("Do you want to restart, or exit the game?");
            await narrate("----------------------------------------------------------------");
            await narrate("Options: z = Restart/x = Exit");
            await narrate("----------------------------------------------------------------");

            const statusRestart = await promptChoice("Do you want to restart, or exit the game?", [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
            ]);

            if (statusRestart === "z") 
            {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x") 
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
            } 
            else if (choiceUser === "x")
        {
                await narrate("You decide not to take the throne. You are a better person than Legoat. You remember Selman's words from another timeline. Humanity is all about the struggle against the tides of fate. You know that humans may be crooked, and they may never change, however, you decide to invest in humanity and take a chance.");
                await narrate("Everything should be fine now. All the passengers are back to normal, and the Shattered Rails Express is back on track. You can go back to your normal life now, but you live for the betterment and hope of humanity. Good luck on your journey struggler!")
                await narrate("*PATH 16 OVER*");
                await narrate("*TRUE ENDING*");

                await narrate("Do you want to restart, or exit the game?");
                await narrate("----------------------------------------------------------------");
                await narrate("Options: z = Restart/x = Exit");
                await narrate("----------------------------------------------------------------");

                const statusRestart = await promptChoice("Do you want to restart, or exit the game?",
                [
                { label: "Restart", value: "z" },
                { label: "Exit", value: "x" }
                ]);

            if (statusRestart === "z") 
            {
                saveGameState(0);
                await beginning();
            } 
            else if (statusRestart === "x") 
            {
                exit();
            } 
            else 
            {
                await narrate("Not a valid option, please try again!.");
            }
        }
        } 

        else 
        {
            await narrate("Not a valid option, please try again!.");
            
        }
    }
    document.addEventListener("DOMContentLoaded", function() {
    applySavedSettings();
    document.getElementById('settings-button').addEventListener('click', function(event) {
        event.preventDefault();
        document.getElementById('settings-popup').classList.toggle('open');
    });
    document.getElementById('close-popup').addEventListener('click', function() {
        document.getElementById('settings-popup').classList.remove('open');
    });
    var resetButton = document.getElementById('reset-button');
    resetButton.addEventListener('click', function() {
        window.location.reload();
    });
    document.getElementById('save-button').addEventListener('click', saveSettings);
});
    
    function applySavedSettings() {
        const savedBgColor = localStorage.getItem('background-color-picker');
        const savedFontFamily = localStorage.getItem('font-family-picker');
        const savedFontSize = localStorage.getItem('font-size');
        const savedTextSpeed = localStorage.getItem('text-speed-selector');
        const savedFontColor = localStorage.getItem('shatteredRailsFontColor');
        const savedTerminalBgColor = localStorage.getItem('shatteredRailsTerminalBgColor');

    
        if (savedBgColor) {
            changeBackgroundColor(savedBgColor);
        }
        if (savedFontFamily) {
            changeFontFamily(savedFontFamily);
        }
        if (savedFontSize) {
            changeFontSize(savedFontSize);
        }
        if (savedTextSpeed) {
            changeTextSpeed(savedTextSpeed);
        }
        if (savedFontColor) {
            changeFontColor(savedFontColor);
        }
        if (savedTerminalBgColor) {
            changeTerminalBgColor(savedTerminalBgColor);
        }
    }
    document.getElementById('reset-button').addEventListener('click', function() {
        localStorage.removeItem('background-color-picker');
        localStorage.removeItem('font-family-picker');
        localStorage.removeItem('font-size');
        localStorage.removeItem('shatteredRailsFontColor');
        localStorage.removeItem('shatteredRailsTerminalBgColor');
        resetUI();
    });

    
    function saveSettings() {
        const bgColor = document.getElementById('background-color-picker').value;
        const fontFamily = document.getElementById('font-family-picker').value;
        const fontSize = document.getElementById('font-size').value;
        const textSpeed = document.getElementById('text-speed-selector').value;
        const fontColor = document.getElementById('shatteredRailsFontColor').value;
        const terminalBgColor = document.getElementById('shatteredRailsTerminalBgColor').value;
    
        localStorage.setItem('background-color-picker', bgColor);
        localStorage.setItem('font-family-picker', fontFamily);
        localStorage.setItem('font-size', fontSize);
        localStorage.setItem('text-speed-selector', textSpeed);
        localStorage.setItem('shatteredRailsFontColor', fontColor);
        localStorage.setItem('shatteredRailsTerminalBgColor', terminalBgColor);
    
        const confirmationMessage = document.getElementById('save-confirmation');
        confirmationMessage.textContent = "Settings saved!";
        confirmationMessage.style.display = "block";

        setTimeout(() => {
            confirmationMessage.style.display = "none";
        }, 3000);
    
    }
//Function to change background color
function changeBackgroundColor(color) {
    document.body.style.backgroundColor = color;
}

//Function to change font color
function changeFontColor(color) {
    document.body.style.color = color;
}

//Function to change font family
function changeFontFamily(font) {
    document.body.style.fontFamily = font;
}

function changeFontSize(size) {
document.body.style.fontSize = size;
document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, label, button, input').forEach(element => {
    element.style.fontSize = size;
});
}
function toggleSettingsPopup() {
    var popup = document.getElementById("settings-popup");
    if (popup.style.right === "0px") {
        popup.style.right = "-400px";
    } else {
        popup.style.right = "0px";
    }
}

document.getElementById('settings-button').addEventListener('click', toggleSettingsPopup);
document.getElementById('close-popup').addEventListener('click', toggleSettingsPopup);

function resetUI() {
    const defaultBgColor = 'monospace'; 
    const defaultFontFamily = 'Arial, sans-serif'; 
    const defaultFontSize = '16px';
    const defaultTextSpeed = '0.5x'; 
    const defaultFontColor = 'white'; 
    const defaultTerminalBgColor = '#121212'; 

    changeBackgroundColor(defaultBgColor);
    document.getElementById('background-color-picker').value = defaultBgColor;

    changeFontFamily(defaultFontFamily);
    document.getElementById('font-family-picker').value = defaultFontFamily;

    changeFontSize(defaultFontSize);
    document.getElementById('font-size').value = defaultFontSize;

    changeFontColor(defaultFontColor);
    document.getElementById('shatteredRailsFontColor').value = defaultFontColor;
    
    changeTerminalBgColor(defaultTerminalBgColor);
    document.getElementById('shatteredRailsTerminalBgColor').value = defaultTerminalBgColor;
    document.getElementById('save-confirmation').style.display = "none";
}
    
    function toggleMenu() {
        var menuItems = document.getElementById("menu-items");
        menuItems.classList.toggle("active");
    }
</script>
    
    {% endif %}
    {% endif %}
</body>

</html>
